<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smartivo - Inward Outward Register</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700;900&family=IBM+Plex+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #0f1419;
            --bg-secondary: #1a1f28;
            --bg-card: #232933;
            --accent-primary: #00a896;
            --accent-secondary: #05668d;
            --accent-teal: #02c39a;
            --text-primary: #e8eef5;
            --text-secondary: #99a5b8;
            --border: rgba(0, 168, 150, 0.15);
            --shadow: 0 4px 24px rgba(0, 0, 0, 0.3);
            --glow: 0 0 12px rgba(0, 168, 150, 0.2);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'IBM Plex Sans', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            overflow-x: hidden;
            position: relative;
        }

        body::before {
            content: '';
            position: fixed;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: 
                radial-gradient(circle at 20% 50%, rgba(0, 168, 150, 0.04) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(5, 102, 141, 0.04) 0%, transparent 50%);
            animation: float 20s ease-in-out infinite;
            pointer-events: none;
            z-index: 0;
        }

        @keyframes float {
            0%, 100% { transform: translate(0, 0) rotate(0deg); }
            33% { transform: translate(30px, -30px) rotate(5deg); }
            66% { transform: translate(-20px, 20px) rotate(-5deg); }
        }

        #root {
            position: relative;
            z-index: 1;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        .header {
            text-align: center;
            margin-bottom: 3rem;
            padding: 2rem 0;
            position: relative;
        }

        .logo-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1.5rem;
            margin-bottom: 1rem;
        }

        .logo-img {
            width: 80px;
            height: 80px;
            object-fit: contain;
        }

        .header h1 {
            font-family: 'Orbitron', sans-serif;
            font-size: 3rem;
            font-weight: 700;
            color: var(--accent-primary);
            margin-bottom: 0.5rem;
            letter-spacing: 2px;
            text-transform: uppercase;
        }

        @keyframes glow {
            0%, 100% { filter: drop-shadow(0 0 4px rgba(0, 168, 150, 0.3)); }
            50% { filter: drop-shadow(0 0 8px rgba(0, 168, 150, 0.4)); }
        }

        .header p {
            color: var(--text-secondary);
            font-size: 1rem;
            font-weight: 300;
        }

        .nav-tabs {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            border-bottom: 2px solid var(--border);
            flex-wrap: wrap;
        }

        .nav-tab {
            padding: 1rem 2rem;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            position: relative;
            transition: all 0.3s ease;
            font-family: 'Orbitron', sans-serif;
            letter-spacing: 0.5px;
        }

        .nav-tab::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            width: 0;
            height: 2px;
            background: var(--accent-primary);
            transition: width 0.3s ease;
        }

        .nav-tab:hover {
            color: var(--accent-primary);
        }

        .nav-tab.active {
            color: var(--text-primary);
        }

        .nav-tab.active::after {
            width: 100%;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 1.5rem;
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background: linear-gradient(90deg, transparent, var(--stat-color), transparent);
            animation: shimmer 3s ease-in-out infinite;
        }

        @keyframes shimmer {
            0%, 100% { transform: translateX(-100%); }
            50% { transform: translateX(100%); }
        }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--glow);
            border-color: var(--stat-color);
        }

        .stat-card.cyan { --stat-color: var(--accent-primary); }
        .stat-card.purple { --stat-color: var(--accent-secondary); }
        .stat-card.green { --stat-color: var(--accent-teal); }
        .stat-card.orange { --stat-color: #f28f3b; }

        .stat-label {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: 700;
            font-family: 'Orbitron', sans-serif;
            color: var(--stat-color);
        }

        .card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: var(--shadow);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .card-title {
            font-size: 1.5rem;
            font-weight: 700;
            font-family: 'Orbitron', sans-serif;
            color: var(--accent-primary);
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .btn:hover::before {
            width: 300px;
            height: 300px;
        }

        .btn span {
            position: relative;
            z-index: 1;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            color: white;
        }

        .btn-primary:hover {
            box-shadow: var(--glow);
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: var(--bg-secondary);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            border-color: var(--accent-cyan);
            color: var(--accent-cyan);
        }

        .btn-danger {
            background: linear-gradient(135deg, #ff4757, #ff6b35);
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, var(--accent-teal), var(--accent-primary));
            color: white;
        }

        .search-filter-bar {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }

        .search-box {
            flex: 1;
            min-width: 250px;
            position: relative;
        }

        .input {
            width: 100%;
            padding: 0.875rem 1rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 0.875rem;
            transition: all 0.3s ease;
        }

        .input:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px rgba(0, 168, 150, 0.1);
        }

        .select {
            padding: 0.875rem 1rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .select:focus {
            outline: none;
            border-color: var(--accent-primary);
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .label {
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .table-container {
            overflow-x: auto;
            border-radius: 12px;
            border: 1px solid var(--border);
        }

        .table {
            width: 100%;
            border-collapse: collapse;
        }

        .table thead {
            background: var(--bg-secondary);
        }

        .table th {
            padding: 1rem;
            text-align: left;
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 1px;
            border-bottom: 2px solid var(--border);
        }

        .table td {
            padding: 1rem;
            border-bottom: 1px solid var(--border);
            color: var(--text-primary);
        }

        .table tbody tr {
            transition: all 0.3s ease;
        }

        .table tbody tr:hover {
            background: rgba(0, 217, 255, 0.05);
        }

        .badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .badge-in-stock {
            background: rgba(2, 195, 154, 0.2);
            color: var(--accent-teal);
            border: 1px solid var(--accent-teal);
        }

        .badge-low-stock {
            background: rgba(242, 143, 59, 0.2);
            color: #f28f3b;
            border: 1px solid #f28f3b;
        }

        .badge-out-stock {
            background: rgba(229, 62, 62, 0.2);
            color: #e53e3e;
            border: 1px solid #e53e3e;
        }

        .badge-inward {
            background: rgba(0, 168, 150, 0.2);
            color: var(--accent-primary);
            border: 1px solid var(--accent-primary);
        }

        .badge-outward {
            background: rgba(5, 102, 141, 0.2);
            color: var(--accent-secondary);
            border: 1px solid var(--accent-secondary);
        }

        .action-buttons {
            display: flex;
            gap: 0.5rem;
        }

        .icon-btn {
            padding: 0.5rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .icon-btn:hover {
            border-color: var(--accent-primary);
            color: var(--accent-primary);
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(10, 14, 39, 0.9);
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 1rem;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 2rem;
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from { transform: translateY(30px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 700;
            font-family: 'Orbitron', sans-serif;
            color: var(--accent-primary);
        }

        .close-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 1.5rem;
            cursor: pointer;
            transition: color 0.3s ease;
        }

        .close-btn:hover {
            color: var(--text-primary);
        }

        .alert {
            padding: 1rem 1.5rem;
            border-radius: 8px;
            margin-bottom: 1.5rem;
            border-left: 4px solid;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { transform: translateX(-20px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .alert-warning {
            background: rgba(242, 143, 59, 0.1);
            border-color: #f28f3b;
            color: #f28f3b;
        }

        .alert-success {
            background: rgba(2, 195, 154, 0.1);
            border-color: var(--accent-teal);
            color: var(--accent-teal);
        }

        .qr-code-container {
            text-align: center;
            padding: 1rem;
            background: white;
            border-radius: 8px;
            margin: 1rem 0;
        }

        .qr-code-container canvas {
            max-width: 100%;
            height: auto;
        }

        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: var(--text-secondary);
        }

        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.3;
        }

        .scanner-container {
            margin: 1.5rem 0;
            border: 2px dashed var(--border);
            border-radius: 12px;
            padding: 1rem;
            background: var(--bg-secondary);
        }

        .scanner-preview {
            width: 100%;
            max-width: 500px;
            margin: 0 auto;
            border-radius: 8px;
            overflow: hidden;
        }

        #qr-reader {
            border-radius: 8px;
        }

        .scanner-controls {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
            justify-content: center;
            flex-wrap: wrap;
        }

        .sync-status {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 0.75rem 1.5rem;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            z-index: 999;
            box-shadow: var(--shadow);
            animation: slideInRight 0.3s ease;
        }

        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .sync-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--accent-teal);
            animation: pulse 2s infinite;
        }

        .sync-indicator.syncing {
            background: #f28f3b;
        }

        .sync-indicator.error {
            background: #e53e3e;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .file-input-label {
            display: inline-block;
            padding: 0.75rem 1.5rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .file-input-label:hover {
            border-color: var(--accent-primary);
            color: var(--accent-primary);
        }

        .file-input-label input {
            display: none;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 2rem;
            }

            .container {
                padding: 1rem;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .card-header {
                flex-direction: column;
                align-items: flex-start;
            }

            .search-filter-bar {
                flex-direction: column;
            }

            .table {
                font-size: 0.875rem;
            }

            .table th,
            .table td {
                padding: 0.75rem 0.5rem;
            }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const DEVICE_TYPES = [
            'Smart Switch', 'Motion Sensor', 'Door Sensor', 'Camera',
            'Smart Lock', 'Thermostat', 'Smart Bulb', 'Hub/Gateway',
            'Smoke Detector', 'Water Leak Sensor', 'Smart Plug', 'Other'
        ];

        const LOCATIONS = [
            'Warehouse', 'Living Room', 'Bedroom', 'Kitchen', 'Bathroom',
            'Garage', 'Office', 'Outdoor', 'Hallway', 'Other'
        ];

        // Cloud Storage Helper Functions with Share Capabilities
        const CloudStorage = {
            async save(key, data) {
                try {
                    // Save to localStorage
                    localStorage.setItem(key, JSON.stringify(data));
                    
                    // Also save to persistent storage if available
                    if (window.storage) {
                        await window.storage.set(key, JSON.stringify(data), true);
                    }
                    
                    return { success: true };
                } catch (error) {
                    console.error('Save error:', error);
                    return { success: false, error };
                }
            },

            async load(key) {
                try {
                    // Try to load from persistent storage first
                    if (window.storage) {
                        try {
                            const result = await window.storage.get(key, true);
                            if (result && result.value) {
                                return JSON.parse(result.value);
                            }
                        } catch (e) {
                            // Key doesn't exist in persistent storage, fall back to localStorage
                        }
                    }
                    
                    // Fall back to localStorage
                    const data = localStorage.getItem(key);
                    return data ? JSON.parse(data) : null;
                } catch (error) {
                    console.error('Load error:', error);
                    return null;
                }
            },

            async generateShareLink(devices, transactions) {
                try {
                    const shareData = {
                        devices,
                        transactions,
                        timestamp: Date.now(),
                        version: '1.0'
                    };
                    
                    // Compress and encode data
                    const jsonString = JSON.stringify(shareData);
                    const compressed = this.compressData(jsonString);
                    
                    // Generate a unique share ID
                    const shareId = 'inv_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                    
                    // Store in persistent storage
                    if (window.storage) {
                        await window.storage.set(shareId, jsonString, true);
                    } else {
                        // Fallback to URL encoding for demo
                        const encoded = btoa(encodeURIComponent(compressed));
                        return {
                            success: true,
                            shareId,
                            url: `${window.location.origin}${window.location.pathname}#share=${encoded}`,
                            method: 'url'
                        };
                    }
                    
                    return {
                        success: true,
                        shareId,
                        url: `${window.location.origin}${window.location.pathname}#share=${shareId}`,
                        method: 'storage'
                    };
                } catch (error) {
                    console.error('Share link generation error:', error);
                    return { success: false, error };
                }
            },

            async loadFromShareLink(shareId) {
                try {
                    // Try to load from persistent storage
                    if (window.storage && !shareId.startsWith('eyJ')) {
                        try {
                            const result = await window.storage.get(shareId, true);
                            if (result && result.value) {
                                return JSON.parse(result.value);
                            }
                        } catch (e) {
                            console.log('Not found in storage, trying URL decode');
                        }
                    }
                    
                    // Try URL decoding (fallback method)
                    try {
                        const decoded = decodeURIComponent(atob(shareId));
                        const decompressed = this.decompressData(decoded);
                        return JSON.parse(decompressed);
                    } catch (e) {
                        console.error('Failed to decode share link:', e);
                        return null;
                    }
                } catch (error) {
                    console.error('Load from share error:', error);
                    return null;
                }
            },

            compressData(str) {
                // Simple compression - in production use proper compression library
                return str;
            },

            decompressData(str) {
                // Simple decompression - in production use proper compression library
                return str;
            },

            async exportToFile(devices, transactions) {
                const exportData = {
                    devices,
                    transactions,
                    exportDate: new Date().toISOString(),
                    version: '1.0'
                };
                
                const blob = new Blob([JSON.stringify(exportData, null, 2)], { 
                    type: 'application/json' 
                });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `inventory_backup_${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);
            },

            async importFromFile(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const data = JSON.parse(e.target.result);
                            resolve(data);
                        } catch (error) {
                            reject(error);
                        }
                    };
                    reader.onerror = reject;
                    reader.readAsText(file);
                });
            }
        };

        function App() {
            const [activeTab, setActiveTab] = useState('dashboard');
            const [devices, setDevices] = useState([]);
            const [transactions, setTransactions] = useState([]);
            const [showModal, setShowModal] = useState(false);
            const [modalType, setModalType] = useState('');
            const [searchTerm, setSearchTerm] = useState('');
            const [filterType, setFilterType] = useState('all');
            const [filterStatus, setFilterStatus] = useState('all');
            const [lowStockThreshold, setLowStockThreshold] = useState(5);
            const [selectedDevice, setSelectedDevice] = useState(null);
            const [qrCodeData, setQrCodeData] = useState(null);
            const [syncStatus, setSyncStatus] = useState('synced'); // synced, syncing, error
            const [scannerActive, setScannerActive] = useState(false);
            const [scannerField, setScannerField] = useState(''); // 'serial' or 'document'
            const [shareLink, setShareLink] = useState('');
            const [showShareModal, setShowShareModal] = useState(false);
            const html5QrCodeRef = useRef(null);

            // Form states
            const [formData, setFormData] = useState({
                name: '',
                type: '',
                serialNumber: '',
                quantity: 1,
                location: '',
                supplier: '',
                purchaseDate: '',
                warrantyMonths: 12,
                price: '',
                notes: '',
                documentId: '', // For tracking outward entries
                entryType: 'inward' // 'inward' or 'outward'
            });

            // Load data from cloud storage
            useEffect(() => {
                const loadData = async () => {
                    setSyncStatus('syncing');
                    
                    // Check if there's a share link in the URL
                    const hash = window.location.hash;
                    if (hash.startsWith('#share=')) {
                        const shareId = hash.substring(7);
                        const sharedData = await CloudStorage.loadFromShareLink(shareId);
                        
                        if (sharedData && sharedData.devices && sharedData.transactions) {
                            if (confirm('Load shared inventory data? This will replace your current data.')) {
                                setDevices(sharedData.devices);
                                setTransactions(sharedData.transactions);
                                setSyncStatus('synced');
                                window.location.hash = ''; // Clear hash
                                return;
                            }
                        } else {
                            alert('Invalid or expired share link');
                        }
                    }
                    
                    // Load normally
                    const savedDevices = await CloudStorage.load('homeAutoDevices');
                    const savedTransactions = await CloudStorage.load('homeAutoTransactions');
                    const savedThreshold = await CloudStorage.load('lowStockThreshold');
                    
                    if (savedDevices) setDevices(savedDevices);
                    if (savedTransactions) setTransactions(savedTransactions);
                    if (savedThreshold) setLowStockThreshold(parseInt(savedThreshold));
                    
                    setSyncStatus('synced');
                };
                loadData();
            }, []);

            // Auto-save data to cloud
            useEffect(() => {
                const saveData = async () => {
                    setSyncStatus('syncing');
                    await CloudStorage.save('homeAutoDevices', devices);
                    setSyncStatus('synced');
                };
                if (devices.length > 0) {
                    saveData();
                }
            }, [devices]);

            useEffect(() => {
                const saveData = async () => {
                    setSyncStatus('syncing');
                    await CloudStorage.save('homeAutoTransactions', transactions);
                    setSyncStatus('synced');
                };
                if (transactions.length > 0) {
                    saveData();
                }
            }, [transactions]);

            useEffect(() => {
                const saveData = async () => {
                    await CloudStorage.save('lowStockThreshold', lowStockThreshold.toString());
                };
                saveData();
            }, [lowStockThreshold]);

            const handleInputChange = (e) => {
                const { name, value } = e.target;
                setFormData(prev => ({ ...prev, [name]: value }));
            };

            const startScanner = (field) => {
                setScannerField(field);
                setScannerActive(true);
                
                setTimeout(() => {
                    if (!html5QrCodeRef.current) {
                        html5QrCodeRef.current = new Html5Qrcode("qr-reader");
                    }

                    const qrCodeSuccessCallback = (decodedText, decodedResult) => {
                        // Update the appropriate field
                        if (field === 'serial') {
                            setFormData(prev => ({ ...prev, serialNumber: decodedText }));
                        } else if (field === 'document') {
                            setFormData(prev => ({ ...prev, documentId: decodedText }));
                        }
                        
                        // Stop scanner
                        stopScanner();
                    };

                    const config = { 
                        fps: 10, 
                        qrbox: { width: 250, height: 250 }
                    };

                    html5QrCodeRef.current.start(
                        { facingMode: "environment" },
                        config,
                        qrCodeSuccessCallback
                    ).catch(err => {
                        console.error("Camera start error:", err);
                        alert("Unable to start camera. Please check permissions or enter manually.");
                        setScannerActive(false);
                    });
                }, 100);
            };

            const stopScanner = () => {
                if (html5QrCodeRef.current) {
                    html5QrCodeRef.current.stop().then(() => {
                        setScannerActive(false);
                    }).catch(err => {
                        console.error("Scanner stop error:", err);
                        setScannerActive(false);
                    });
                }
            };

            const openModal = (type, device = null) => {
                setModalType(type);
                setShowModal(true);
                if (device) {
                    setSelectedDevice(device);
                    setFormData({
                        ...device,
                        quantity: 1,
                        documentId: '',
                        entryType: type === 'outward' ? 'outward' : 'inward'
                    });
                } else {
                    setSelectedDevice(null);
                    setFormData({
                        name: '',
                        type: '',
                        serialNumber: '',
                        quantity: 1,
                        location: '',
                        supplier: '',
                        purchaseDate: '',
                        warrantyMonths: 12,
                        price: '',
                        notes: '',
                        documentId: '',
                        entryType: 'inward'
                    });
                }
            };

            const closeModal = () => {
                if (scannerActive) {
                    stopScanner();
                }
                setShowModal(false);
                setModalType('');
                setSelectedDevice(null);
                setQrCodeData(null);
            };

            const addInward = async () => {
                setSyncStatus('syncing');
                
                // Check if device already exists
                const existing = devices.find(d => 
                    d.name === formData.name && 
                    d.type === formData.type &&
                    d.serialNumber === formData.serialNumber
                );

                if (formData.entryType === 'outward') {
                    // If outward, device must exist
                    if (!existing) {
                        alert('Cannot create outward entry: Device does not exist in inventory. Please add it first as inward.');
                        setSyncStatus('synced');
                        return;
                    }
                    
                    // Check if sufficient quantity available
                    if (existing.quantity < parseInt(formData.quantity)) {
                        alert(`Insufficient quantity. Available: ${existing.quantity}`);
                        setSyncStatus('synced');
                        return;
                    }
                    
                    // Reduce quantity
                    setDevices(prev => prev.map(d => 
                        d.id === existing.id 
                            ? { ...d, quantity: d.quantity - parseInt(formData.quantity) }
                            : d
                    ));

                    const transaction = {
                        id: Date.now().toString(),
                        type: 'outward',
                        deviceId: existing.id,
                        deviceName: existing.name,
                        quantity: parseInt(formData.quantity),
                        documentId: formData.documentId,
                        date: new Date().toISOString(),
                        notes: formData.notes || 'Stock dispatched'
                    };
                    setTransactions(prev => [transaction, ...prev]);
                } else {
                    // Inward entry
                    if (existing) {
                        // Add to existing device
                        setDevices(prev => prev.map(d => 
                            d.id === existing.id 
                                ? { ...d, quantity: d.quantity + parseInt(formData.quantity) }
                                : d
                        ));

                        const transaction = {
                            id: Date.now().toString(),
                            type: 'inward',
                            deviceId: existing.id,
                            deviceName: existing.name,
                            quantity: parseInt(formData.quantity),
                            date: new Date().toISOString(),
                            notes: formData.notes || 'Stock added'
                        };
                        setTransactions(prev => [transaction, ...prev]);
                    } else {
                        // Create new device
                        const newDevice = {
                            id: Date.now().toString(),
                            ...formData,
                            quantity: parseInt(formData.quantity),
                            price: parseFloat(formData.price) || 0,
                            warrantyMonths: parseInt(formData.warrantyMonths),
                            createdAt: new Date().toISOString()
                        };

                        setDevices(prev => [...prev, newDevice]);
                        
                        const transaction = {
                            id: Date.now().toString(),
                            type: 'inward',
                            deviceId: newDevice.id,
                            deviceName: newDevice.name,
                            quantity: newDevice.quantity,
                            date: new Date().toISOString(),
                            notes: formData.notes || 'Initial stock entry'
                        };
                        setTransactions(prev => [transaction, ...prev]);
                    }
                }
                
                setSyncStatus('synced');
                closeModal();
            };

            const addBatchInward = async () => {
                setSyncStatus('syncing');
                const existing = devices.find(d => 
                    d.type === formData.type && 
                    d.name === formData.name &&
                    d.serialNumber === formData.serialNumber
                );

                if (existing) {
                    setDevices(prev => prev.map(d => 
                        d.id === existing.id 
                            ? { ...d, quantity: d.quantity + parseInt(formData.quantity) }
                            : d
                    ));

                    const transaction = {
                        id: Date.now().toString(),
                        type: 'inward',
                        deviceId: existing.id,
                        deviceName: existing.name,
                        quantity: parseInt(formData.quantity),
                        date: new Date().toISOString(),
                        notes: `Batch addition`
                    };
                    setTransactions(prev => [transaction, ...prev]);
                } else {
                    await addInward();
                    return;
                }
                
                setSyncStatus('synced');
                closeModal();
            };

            const addOutward = async () => {
                if (selectedDevice && parseInt(formData.quantity) <= selectedDevice.quantity) {
                    setSyncStatus('syncing');
                    setDevices(prev => prev.map(d => 
                        d.id === selectedDevice.id 
                            ? { ...d, quantity: d.quantity - parseInt(formData.quantity) }
                            : d
                    ));

                    const transaction = {
                        id: Date.now().toString(),
                        type: 'outward',
                        deviceId: selectedDevice.id,
                        deviceName: selectedDevice.name,
                        quantity: parseInt(formData.quantity),
                        documentId: formData.documentId, // Track document ID
                        date: new Date().toISOString(),
                        notes: formData.notes || 'Stock dispatched'
                    };
                    setTransactions(prev => [transaction, ...prev]);
                    
                    setSyncStatus('synced');
                    closeModal();
                }
            };

            const deleteDevice = (id) => {
                if (confirm('Are you sure you want to delete this device?')) {
                    setSyncStatus('syncing');
                    setDevices(prev => prev.filter(d => d.id !== id));
                    setSyncStatus('synced');
                }
            };

            const generateQRCode = (device) => {
                const qrData = {
                    id: device.id,
                    name: device.name,
                    type: device.type,
                    serial: device.serialNumber,
                    location: device.location
                };
                
                setQrCodeData(device);
                setModalType('qr');
                setShowModal(true);

                setTimeout(() => {
                    const canvas = document.getElementById('qr-canvas');
                    if (canvas) {
                        QRCode.toCanvas(canvas, JSON.stringify(qrData), {
                            width: 300,
                            margin: 2,
                            color: {
                                dark: '#0a0e27',
                                light: '#ffffff'
                            }
                        });
                    }
                }, 100);
            };

            const downloadQRCode = () => {
                const canvas = document.getElementById('qr-canvas');
                if (canvas) {
                    const url = canvas.toDataURL('image/png');
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `QR_${qrCodeData.name}_${qrCodeData.serialNumber}.png`;
                    a.click();
                }
            };

            const exportToCSV = () => {
                const headers = ['Name', 'Type', 'Serial Number', 'Quantity', 'Location', 'Supplier', 'Purchase Date', 'Warranty (Months)', 'Price', 'Notes'];
                const rows = filteredDevices.map(d => [
                    d.name,
                    d.type,
                    d.serialNumber,
                    d.quantity,
                    d.location,
                    d.supplier,
                    d.purchaseDate,
                    d.warrantyMonths,
                    d.price,
                    d.notes
                ]);

                const csvContent = [
                    headers.join(','),
                    ...rows.map(row => row.map(cell => `"${cell}"`).join(','))
                ].join('\n');

                const blob = new Blob([csvContent], { type: 'text/csv' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `inventory_${new Date().toISOString().split('T')[0]}.csv`;
                a.click();
            };

            const handleExportBackup = async () => {
                setSyncStatus('syncing');
                await CloudStorage.exportToFile(devices, transactions);
                setSyncStatus('synced');
            };

            const handleImportBackup = async (event) => {
                const file = event.target.files[0];
                if (file) {
                    try {
                        setSyncStatus('syncing');
                        const data = await CloudStorage.importFromFile(file);
                        
                        if (data.devices && data.transactions) {
                            if (confirm('This will replace all existing data. Continue?')) {
                                setDevices(data.devices);
                                setTransactions(data.transactions);
                                alert('Data imported successfully!');
                            }
                        } else {
                            alert('Invalid backup file format');
                        }
                        setSyncStatus('synced');
                    } catch (error) {
                        console.error('Import error:', error);
                        alert('Failed to import data');
                        setSyncStatus('error');
                    }
                }
                event.target.value = '';
            };

            const handleGenerateShareLink = async () => {
                setSyncStatus('syncing');
                const result = await CloudStorage.generateShareLink(devices, transactions);
                
                if (result.success) {
                    setShareLink(result.url);
                    setShowShareModal(true);
                    setSyncStatus('synced');
                } else {
                    alert('Failed to generate share link. Please try again.');
                    setSyncStatus('error');
                }
            };

            const copyShareLink = () => {
                navigator.clipboard.writeText(shareLink).then(() => {
                    alert('Link copied to clipboard! Share it with your team.');
                }).catch(() => {
                    // Fallback for older browsers
                    const textArea = document.createElement('textarea');
                    textArea.value = shareLink;
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                    alert('Link copied to clipboard! Share it with your team.');
                });
            };

            // Statistics
            const stats = {
                totalDevices: devices.reduce((sum, d) => sum + d.quantity, 0),
                totalTypes: new Set(devices.map(d => d.type)).size,
                lowStockItems: devices.filter(d => d.quantity <= lowStockThreshold && d.quantity > 0).length,
                outOfStock: devices.filter(d => d.quantity === 0).length,
                totalValue: devices.reduce((sum, d) => sum + (d.price * d.quantity), 0)
            };

            // Filter devices
            const filteredDevices = devices.filter(device => {
                const matchesSearch = device.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                                    device.serialNumber.toLowerCase().includes(searchTerm.toLowerCase()) ||
                                    device.type.toLowerCase().includes(searchTerm.toLowerCase());
                const matchesType = filterType === 'all' || device.type === filterType;
                const matchesStatus = filterStatus === 'all' || 
                    (filterStatus === 'in-stock' && device.quantity > lowStockThreshold) ||
                    (filterStatus === 'low-stock' && device.quantity > 0 && device.quantity <= lowStockThreshold) ||
                    (filterStatus === 'out-stock' && device.quantity === 0);
                
                return matchesSearch && matchesType && matchesStatus;
            });

            const getStockStatus = (quantity) => {
                if (quantity === 0) return 'out-stock';
                if (quantity <= lowStockThreshold) return 'low-stock';
                return 'in-stock';
            };

            const getStockBadge = (quantity) => {
                const status = getStockStatus(quantity);
                return (
                    <span className={`badge badge-${status}`}>
                        {status === 'out-stock' ? 'Out of Stock' : 
                         status === 'low-stock' ? 'Low Stock' : 'In Stock'}
                    </span>
                );
            };

            const lowStockAlerts = devices.filter(d => 
                d.quantity <= lowStockThreshold && d.quantity > 0
            );

            return (
                <div className="container">
                    {/* Sync Status Indicator */}
                    <div className="sync-status">
                        <div className={`sync-indicator ${syncStatus}`}></div>
                        <span style={{ fontSize: '0.875rem', color: 'var(--text-secondary)' }}>
                            {syncStatus === 'synced' && '✓ Synced'}
                            {syncStatus === 'syncing' && '↻ Syncing...'}
                            {syncStatus === 'error' && '✗ Sync Error'}
                        </span>
                    </div>

                    <header className="header">
                        <div className="logo-container">
                            <img 
                                src="data:image/png;base64,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" 
                                alt="Smartivo Logo" 
                                className="logo-img"
                            />
                            <h1>Smartivo</h1>
                        </div>
                        <p>Inward-Outward Register</p>
                    </header>

                    <div className="nav-tabs">
                        <button 
                            className={`nav-tab ${activeTab === 'dashboard' ? 'active' : ''}`}
                            onClick={() => setActiveTab('dashboard')}
                        >
                            Dashboard
                        </button>
                        <button 
                            className={`nav-tab ${activeTab === 'inventory' ? 'active' : ''}`}
                            onClick={() => setActiveTab('inventory')}
                        >
                            Inventory
                        </button>
                        <button 
                            className={`nav-tab ${activeTab === 'transactions' ? 'active' : ''}`}
                            onClick={() => setActiveTab('transactions')}
                        >
                            Transactions
                        </button>
                    </div>

                    {activeTab === 'dashboard' && (
                        <div>
                            <div className="stats-grid">
                                <div className="stat-card cyan">
                                    <div className="stat-label">Total Devices</div>
                                    <div className="stat-value">{stats.totalDevices}</div>
                                </div>
                                <div className="stat-card purple">
                                    <div className="stat-label">Device Types</div>
                                    <div className="stat-value">{stats.totalTypes}</div>
                                </div>
                                <div className="stat-card orange">
                                    <div className="stat-label">Low Stock</div>
                                    <div className="stat-value">{stats.lowStockItems}</div>
                                </div>
                                <div className="stat-card green">
                                    <div className="stat-label">Total Value</div>
                                    <div className="stat-value">₹{stats.totalValue.toLocaleString()}</div>
                                </div>
                            </div>

                            {lowStockAlerts.length > 0 && (
                                <div className="alert alert-warning">
                                    <strong>⚠️ Low Stock Alert:</strong> {lowStockAlerts.length} item(s) running low: {' '}
                                    {lowStockAlerts.map(d => `${d.name} (${d.quantity})`).join(', ')}
                                </div>
                            )}

                            <div className="card">
                                <div className="card-header">
                                    <h2 className="card-title">Quick Actions</h2>
                                </div>
                                <div style={{ display: 'flex', gap: '1rem', flexWrap: 'wrap' }}>
                                    <button className="btn btn-primary" onClick={() => openModal('inward')}>
                                        <span>➕ Add Entry</span>
                                    </button>
                                    <button className="btn btn-primary" onClick={() => openModal('batch')}>
                                        <span>📦 Batch Inward</span>
                                    </button>
                                    <button className="btn btn-secondary" onClick={exportToCSV}>
                                        <span>📊 Export to CSV</span>
                                    </button>
                                    <button className="btn btn-success" onClick={handleGenerateShareLink}>
                                        <span>🔗 Generate Share Link</span>
                                    </button>
                                    <button className="btn btn-secondary" onClick={handleExportBackup}>
                                        <span>💾 Backup Data</span>
                                    </button>
                                    <label className="file-input-label">
                                        <input type="file" accept=".json" onChange={handleImportBackup} />
                                        <span>📥 Import Backup</span>
                                    </label>
                                </div>
                            </div>

                            <div className="card">
                                <div className="card-header">
                                    <h2 className="card-title">Recent Transactions</h2>
                                </div>
                                <div className="table-container">
                                    <table className="table">
                                        <thead>
                                            <tr>
                                                <th>Date</th>
                                                <th>Type</th>
                                                <th>Device</th>
                                                <th>Quantity</th>
                                                <th>Document ID</th>
                                                <th>Notes</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {transactions.slice(0, 10).map(t => (
                                                <tr key={t.id}>
                                                    <td>{new Date(t.date).toLocaleString()}</td>
                                                    <td>
                                                        <span className={`badge badge-${t.type}`}>
                                                            {t.type === 'inward' ? '⬇️ Inward' : '⬆️ Outward'}
                                                        </span>
                                                    </td>
                                                    <td>{t.deviceName}</td>
                                                    <td>{t.quantity}</td>
                                                    <td>{t.documentId || '-'}</td>
                                                    <td>{t.notes}</td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                    {transactions.length === 0 && (
                                        <div className="empty-state">
                                            <div className="empty-state-icon">📋</div>
                                            <p>No transactions yet</p>
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>
                    )}

                    {activeTab === 'inventory' && (
                        <div>
                            <div className="card">
                                <div className="card-header">
                                    <h2 className="card-title">Device Inventory</h2>
                                    <div style={{ display: 'flex', gap: '1rem', flexWrap: 'wrap' }}>
                                        <button className="btn btn-primary" onClick={() => openModal('inward')}>
                                            <span>➕ Add Device</span>
                                        </button>
                                        <button className="btn btn-secondary" onClick={exportToCSV}>
                                            <span>📊 Export</span>
                                        </button>
                                    </div>
                                </div>

                                <div className="search-filter-bar">
                                    <div className="search-box">
                                        <input
                                            type="text"
                                            className="input"
                                            placeholder="🔍 Search devices..."
                                            value={searchTerm}
                                            onChange={(e) => setSearchTerm(e.target.value)}
                                        />
                                    </div>
                                    <select 
                                        className="select"
                                        value={filterType}
                                        onChange={(e) => setFilterType(e.target.value)}
                                    >
                                        <option value="all">All Types</option>
                                        {DEVICE_TYPES.map(type => (
                                            <option key={type} value={type}>{type}</option>
                                        ))}
                                    </select>
                                    <select 
                                        className="select"
                                        value={filterStatus}
                                        onChange={(e) => setFilterStatus(e.target.value)}
                                    >
                                        <option value="all">All Status</option>
                                        <option value="in-stock">In Stock</option>
                                        <option value="low-stock">Low Stock</option>
                                        <option value="out-stock">Out of Stock</option>
                                    </select>
                                </div>

                                <div className="table-container">
                                    <table className="table">
                                        <thead>
                                            <tr>
                                                <th>Name</th>
                                                <th>Type</th>
                                                <th>Serial No.</th>
                                                <th>Quantity</th>
                                                <th>Status</th>
                                                <th>Location</th>
                                                <th>Supplier</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {filteredDevices.map(device => (
                                                <tr key={device.id}>
                                                    <td><strong>{device.name}</strong></td>
                                                    <td>{device.type}</td>
                                                    <td>{device.serialNumber}</td>
                                                    <td><strong>{device.quantity}</strong></td>
                                                    <td>{getStockBadge(device.quantity)}</td>
                                                    <td>{device.location}</td>
                                                    <td>{device.supplier}</td>
                                                    <td>
                                                        <div className="action-buttons">
                                                            <button 
                                                                className="icon-btn"
                                                                onClick={() => openModal('outward', device)}
                                                                title="Outward"
                                                            >
                                                                ⬆️
                                                            </button>
                                                            <button 
                                                                className="icon-btn"
                                                                onClick={() => generateQRCode(device)}
                                                                title="Generate QR"
                                                            >
                                                                📱
                                                            </button>
                                                            <button 
                                                                className="icon-btn"
                                                                onClick={() => deleteDevice(device.id)}
                                                                title="Delete"
                                                            >
                                                                🗑️
                                                            </button>
                                                        </div>
                                                    </td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                    {filteredDevices.length === 0 && (
                                        <div className="empty-state">
                                            <div className="empty-state-icon">📦</div>
                                            <p>No devices found</p>
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>
                    )}

                    {activeTab === 'transactions' && (
                        <div className="card">
                            <div className="card-header">
                                <h2 className="card-title">Transaction History</h2>
                            </div>
                            <div className="table-container">
                                <table className="table">
                                    <thead>
                                        <tr>
                                            <th>Date & Time</th>
                                            <th>Type</th>
                                            <th>Device Name</th>
                                            <th>Quantity</th>
                                            <th>Document ID</th>
                                            <th>Notes</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {transactions.map(t => (
                                            <tr key={t.id}>
                                                <td>{new Date(t.date).toLocaleString()}</td>
                                                <td>
                                                    <span className={`badge badge-${t.type}`}>
                                                        {t.type === 'inward' ? '⬇️ Inward' : '⬆️ Outward'}
                                                    </span>
                                                </td>
                                                <td>{t.deviceName}</td>
                                                <td><strong>{t.quantity}</strong></td>
                                                <td><strong>{t.documentId || '-'}</strong></td>
                                                <td>{t.notes}</td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                                {transactions.length === 0 && (
                                    <div className="empty-state">
                                        <div className="empty-state-icon">📋</div>
                                        <p>No transactions recorded</p>
                                    </div>
                                )}
                            </div>
                        </div>
                    )}

                    {showModal && (
                        <div className="modal-overlay" onClick={closeModal}>
                            <div className="modal" onClick={(e) => e.stopPropagation()}>
                                <div className="modal-header">
                                    <h3 className="modal-title">
                                        {modalType === 'inward' && '📝 Add Device Entry'}
                                        {modalType === 'batch' && '📦 Batch Inward Entry'}
                                        {modalType === 'outward' && '⬆️ Outward Entry'}
                                        {modalType === 'qr' && '📱 QR Code'}
                                    </h3>
                                    <button className="close-btn" onClick={closeModal}>×</button>
                                </div>

                                {modalType === 'qr' && qrCodeData ? (
                                    <div>
                                        <div className="qr-code-container">
                                            <canvas id="qr-canvas"></canvas>
                                        </div>
                                        <div style={{ marginTop: '1rem' }}>
                                            <p><strong>Device:</strong> {qrCodeData.name}</p>
                                            <p><strong>Type:</strong> {qrCodeData.type}</p>
                                            <p><strong>Serial:</strong> {qrCodeData.serialNumber}</p>
                                            <p><strong>Location:</strong> {qrCodeData.location}</p>
                                        </div>
                                        <div style={{ marginTop: '1.5rem', display: 'flex', gap: '1rem' }}>
                                            <button className="btn btn-primary" onClick={downloadQRCode}>
                                                <span>💾 Download QR Code</span>
                                            </button>
                                            <button className="btn btn-secondary" onClick={closeModal}>
                                                <span>Close</span>
                                            </button>
                                        </div>
                                    </div>
                                ) : (
                                    <form onSubmit={(e) => {
                                        e.preventDefault();
                                        if (modalType === 'inward') addInward();
                                        else if (modalType === 'batch') addBatchInward();
                                        else if (modalType === 'outward') addOutward();
                                    }}>
                                        {/* Entry Type Selector - Only show for 'inward' modal */}
                                        {modalType === 'inward' && (
                                            <div style={{ 
                                                marginBottom: '1.5rem', 
                                                padding: '1rem', 
                                                background: 'var(--bg-secondary)', 
                                                borderRadius: '8px',
                                                border: '1px solid var(--border)'
                                            }}>
                                                <label className="label" style={{ marginBottom: '0.75rem' }}>Entry Type *</label>
                                                <div style={{ display: 'flex', gap: '1rem' }}>
                                                    <label style={{ 
                                                        flex: 1, 
                                                        display: 'flex', 
                                                        alignItems: 'center', 
                                                        gap: '0.5rem',
                                                        cursor: 'pointer',
                                                        padding: '0.75rem',
                                                        background: formData.entryType === 'inward' ? 'rgba(0, 168, 150, 0.1)' : 'transparent',
                                                        border: formData.entryType === 'inward' ? '2px solid var(--accent-primary)' : '2px solid var(--border)',
                                                        borderRadius: '8px',
                                                        transition: 'all 0.3s ease'
                                                    }}>
                                                        <input 
                                                            type="radio" 
                                                            name="entryType" 
                                                            value="inward"
                                                            checked={formData.entryType === 'inward'}
                                                            onChange={handleInputChange}
                                                            style={{ cursor: 'pointer' }}
                                                        />
                                                        <span style={{ fontWeight: '500' }}>⬇️ Inward (Receiving Stock)</span>
                                                    </label>
                                                    <label style={{ 
                                                        flex: 1, 
                                                        display: 'flex', 
                                                        alignItems: 'center', 
                                                        gap: '0.5rem',
                                                        cursor: 'pointer',
                                                        padding: '0.75rem',
                                                        background: formData.entryType === 'outward' ? 'rgba(5, 102, 141, 0.1)' : 'transparent',
                                                        border: formData.entryType === 'outward' ? '2px solid var(--accent-secondary)' : '2px solid var(--border)',
                                                        borderRadius: '8px',
                                                        transition: 'all 0.3s ease'
                                                    }}>
                                                        <input 
                                                            type="radio" 
                                                            name="entryType" 
                                                            value="outward"
                                                            checked={formData.entryType === 'outward'}
                                                            onChange={handleInputChange}
                                                            style={{ cursor: 'pointer' }}
                                                        />
                                                        <span style={{ fontWeight: '500' }}>⬆️ Outward (Dispatching Stock)</span>
                                                    </label>
                                                </div>
                                            </div>
                                        )}

                                        {/* Scanner Section */}
                                        {scannerActive && (
                                            <div className="scanner-container">
                                                <div className="scanner-preview">
                                                    <div id="qr-reader"></div>
                                                </div>
                                                <div className="scanner-controls">
                                                    <button type="button" className="btn btn-secondary" onClick={stopScanner}>
                                                        <span>✕ Stop Scanner</span>
                                                    </button>
                                                </div>
                                            </div>
                                        )}

                                        <div className="form-grid">
                                            <div className="form-group">
                                                <label className="label">Device Name *</label>
                                                <input
                                                    type="text"
                                                    name="name"
                                                    className="input"
                                                    value={formData.name}
                                                    onChange={handleInputChange}
                                                    required
                                                    disabled={modalType === 'outward'}
                                                />
                                            </div>
                                            <div className="form-group">
                                                <label className="label">Device Type *</label>
                                                <select
                                                    name="type"
                                                    className="select"
                                                    value={formData.type}
                                                    onChange={handleInputChange}
                                                    required
                                                    disabled={modalType === 'outward'}
                                                >
                                                    <option value="">Select Type</option>
                                                    {DEVICE_TYPES.map(type => (
                                                        <option key={type} value={type}>{type}</option>
                                                    ))}
                                                </select>
                                            </div>
                                            <div className="form-group">
                                                <label className="label">Serial Number</label>
                                                <div style={{ display: 'flex', gap: '0.5rem' }}>
                                                    <input
                                                        type="text"
                                                        name="serialNumber"
                                                        className="input"
                                                        value={formData.serialNumber}
                                                        onChange={handleInputChange}
                                                        disabled={modalType === 'outward'}
                                                        style={{ flex: 1 }}
                                                    />
                                                    {(modalType !== 'outward' && (modalType !== 'inward' || formData.entryType === 'inward')) && !scannerActive && (
                                                        <button 
                                                            type="button" 
                                                            className="btn btn-secondary"
                                                            onClick={() => startScanner('serial')}
                                                            style={{ padding: '0.75rem 1rem', whiteSpace: 'nowrap' }}
                                                        >
                                                            <span>📷 Scan</span>
                                                        </button>
                                                    )}
                                                </div>
                                            </div>
                                            <div className="form-group">
                                                <label className="label">Quantity *</label>
                                                <input
                                                    type="number"
                                                    name="quantity"
                                                    className="input"
                                                    value={formData.quantity}
                                                    onChange={handleInputChange}
                                                    min="1"
                                                    max={modalType === 'outward' ? selectedDevice?.quantity : undefined}
                                                    required
                                                />
                                                {modalType === 'outward' && (
                                                    <small style={{ color: 'var(--text-secondary)' }}>
                                                        Available: {selectedDevice?.quantity}
                                                    </small>
                                                )}
                                            </div>
                                            
                                            {/* Document ID Field for Outward */}
                                            {(modalType === 'outward' || (modalType === 'inward' && formData.entryType === 'outward')) && (
                                                <div className="form-group" style={{ gridColumn: '1 / -1' }}>
                                                    <label className="label">Document ID (Invoice/PO/Delivery Note) *</label>
                                                    <div style={{ display: 'flex', gap: '0.5rem' }}>
                                                        <input
                                                            type="text"
                                                            name="documentId"
                                                            className="input"
                                                            value={formData.documentId}
                                                            onChange={handleInputChange}
                                                            placeholder="e.g., INV-2024-001, PO-12345"
                                                            required
                                                            style={{ flex: 1 }}
                                                        />
                                                        {!scannerActive && (
                                                            <button 
                                                                type="button" 
                                                                className="btn btn-secondary"
                                                                onClick={() => startScanner('document')}
                                                                style={{ padding: '0.75rem 1rem', whiteSpace: 'nowrap' }}
                                                            >
                                                                <span>📷 Scan</span>
                                                            </button>
                                                        )}
                                                    </div>
                                                    <small style={{ color: 'var(--text-secondary)', marginTop: '0.25rem', display: 'block' }}>
                                                        Scan or enter the document ID to track this outward entry
                                                    </small>
                                                </div>
                                            )}

                                            {(modalType !== 'outward' && (modalType !== 'inward' || formData.entryType === 'inward')) && (
                                                <>
                                                    <div className="form-group">
                                                        <label className="label">Location</label>
                                                        <select
                                                            name="location"
                                                            className="select"
                                                            value={formData.location}
                                                            onChange={handleInputChange}
                                                        >
                                                            <option value="">Select Location</option>
                                                            {LOCATIONS.map(loc => (
                                                                <option key={loc} value={loc}>{loc}</option>
                                                            ))}
                                                        </select>
                                                    </div>
                                                    <div className="form-group">
                                                        <label className="label">Supplier</label>
                                                        <input
                                                            type="text"
                                                            name="supplier"
                                                            className="input"
                                                            value={formData.supplier}
                                                            onChange={handleInputChange}
                                                        />
                                                    </div>
                                                    <div className="form-group">
                                                        <label className="label">Purchase Date</label>
                                                        <input
                                                            type="date"
                                                            name="purchaseDate"
                                                            className="input"
                                                            value={formData.purchaseDate}
                                                            onChange={handleInputChange}
                                                        />
                                                    </div>
                                                    <div className="form-group">
                                                        <label className="label">Warranty (Months)</label>
                                                        <input
                                                            type="number"
                                                            name="warrantyMonths"
                                                            className="input"
                                                            value={formData.warrantyMonths}
                                                            onChange={handleInputChange}
                                                            min="0"
                                                        />
                                                    </div>
                                                    <div className="form-group">
                                                        <label className="label">Price (₹)</label>
                                                        <input
                                                            type="number"
                                                            name="price"
                                                            className="input"
                                                            value={formData.price}
                                                            onChange={handleInputChange}
                                                            step="0.01"
                                                            min="0"
                                                        />
                                                    </div>
                                                </>
                                            )}
                                        </div>
                                        <div className="form-group" style={{ marginTop: '1rem' }}>
                                            <label className="label">Notes</label>
                                            <textarea
                                                name="notes"
                                                className="input"
                                                value={formData.notes}
                                                onChange={handleInputChange}
                                                rows="3"
                                                style={{ resize: 'vertical' }}
                                            />
                                        </div>
                                        <div style={{ marginTop: '1.5rem', display: 'flex', gap: '1rem', justifyContent: 'flex-end' }}>
                                            <button type="button" className="btn btn-secondary" onClick={closeModal}>
                                                <span>Cancel</span>
                                            </button>
                                            <button type="submit" className="btn btn-success">
                                                <span>
                                                    {modalType === 'inward' && formData.entryType === 'inward' && '✅ Add Inward'}
                                                    {modalType === 'inward' && formData.entryType === 'outward' && '✅ Add Outward'}
                                                    {modalType === 'batch' && '✅ Add Batch'}
                                                    {modalType === 'outward' && '✅ Dispatch'}
                                                </span>
                                            </button>
                                        </div>
                                    </form>
                                )}
                            </div>
                        </div>
                    )}

                    {/* Share Link Modal */}
                    {showShareModal && (
                        <div className="modal-overlay" onClick={() => setShowShareModal(false)}>
                            <div className="modal" onClick={(e) => e.stopPropagation()}>
                                <div className="modal-header">
                                    <h3 className="modal-title">🔗 Share Your Inventory</h3>
                                    <button className="close-btn" onClick={() => setShowShareModal(false)}>×</button>
                                </div>
                                
                                <div style={{ marginBottom: '1.5rem' }}>
                                    <p style={{ color: 'var(--text-secondary)', marginBottom: '1rem' }}>
                                        Share this link with your team to give them access to your current inventory data.
                                        They can view and import it into their own system.
                                    </p>
                                    
                                    <div style={{ 
                                        background: 'var(--bg-secondary)', 
                                        padding: '1rem', 
                                        borderRadius: '8px',
                                        border: '1px solid var(--border)',
                                        wordBreak: 'break-all',
                                        marginBottom: '1rem'
                                    }}>
                                        <code style={{ color: 'var(--accent-primary)', fontSize: '0.875rem' }}>
                                            {shareLink}
                                        </code>
                                    </div>
                                    
                                    <div style={{ display: 'flex', gap: '1rem', flexWrap: 'wrap' }}>
                                        <button className="btn btn-primary" onClick={copyShareLink}>
                                            <span>📋 Copy Link</span>
                                        </button>
                                        <button className="btn btn-secondary" onClick={() => setShowShareModal(false)}>
                                            <span>Close</span>
                                        </button>
                                    </div>
                                    
                                    <div className="alert alert-warning" style={{ marginTop: '1.5rem' }}>
                                        <strong>⚠️ Note:</strong> Anyone with this link can view your inventory data. 
                                        Only share with trusted team members.
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>